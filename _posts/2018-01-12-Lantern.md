---
layout: post
title: 'Linux 下 Lantern 关闭后不清除代理'
date: '2018-01-12'
header-img: "img/post-bg-unix.jpg"
tags:
     - Linux
author: 'Bro Qiang'
---

# Linux 下 Lantern 关闭后不清除代理

个人觉得这个是一个 bug，Issues 中也有人提出了，不过官方一直没有解决，平时使用起来比较麻烦，只能自己写一个脚本来解决一下，虽然也不是很优雅，不过比起每次都手动去配置要方便一些。

## 配置一个清理的脚本

#### 在家目录下创建一个 bin 目录
```shell
mkdir ~/bin
```
#### 然后在 bin 目录下新建一个 lantern_clear （名字随意起)，写入下面内容：
```shell
#!/bin/bash
#

if ps aux | grep 'lantern$' > /dev/null ; then
    killall -9 lantern
fi

if [[ $UID -eq 0 ]]; then
    su - bro -c "gsettings set org.gnome.system.proxy mode none"
else
    gsettings set org.gnome.system.proxy mode none
fi
```

#### 给脚本添加执行权限
```shell
chmod +x ~/bin/lanternclear
```
然后执行脚本就可以将lantern结束了
终端直接执行或者 Alt+F2执行 lantern_clear
可以在 ~/.bash_logout 中执行脚本
这样可以在每次关机或者注销的时候检测一下lantern，如果存在就可以自动取消，下次登录就是正常的网络了。

#### 编辑家目录下的 .bash_logout，再最后加上

#### 目录根据实际的目录去配置
```shell
/home/bro/bin/lanternclear
```
希望能帮助到遇到相同问题的人，这个是我的解决方案，虽然要手动搞一下，但是基本还是比较方便的。

## 配置到 Systemd 中

写一个 Service，实现关机自动执行这个清理脚本，这样就可以保证重启后还能正常使用网络

新建一个 Service

```shell
sudo vim /lib/systemd/system/lanternclear.service
```

写入下面内容

```shell
[Unit]
Description=Clear lantern proxy on reboot and shutdown
Requires=network.target
 
[Service]
Type=simple
ExecStart=/bin/true
RemainAfterExit=true
ExecStop=/home/bro/bin/lanternclear
  
[Install]
WantedBy=multi-user.target graphical.target
```

将 Service 启用

```shell
sudo systemctl enable lanternclear
```

现在就可以重启查看效果了

```shell
reboot
```